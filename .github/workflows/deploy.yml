name: Deploy App & Bot

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy-app:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build (project pages base)
        working-directory: ./app
        run: npm run build -- --base="/${{ github.event.repository.name }}/"

      - name: Create 404.html for SPA
        run: cp ./app/dist/index.html ./app/dist/404.html

      - name: Add .nojekyll
        run: touch ./app/dist/.nojekyll

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./app/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-bot:
    name: Deploy Telegram Bot to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Ensure remote directories
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
            set -e
            echo "${{ secrets.SERVER_PASSWORD }}" | sudo -S mkdir -p /opt/telegram-bot/bot
            echo "${{ secrets.SERVER_PASSWORD }}" | sudo -S chown -R $USER:$USER /opt/telegram-bot
          '

      - name: Rsync bot sources
        run: |
          rsync -avz --delete -e "ssh -p ${{ secrets.SERVER_PORT }}" \
            --exclude=".git" \
            --exclude="node_modules" \
            bot/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/telegram-bot/bot/

      - name: Install deps (auto-detect runtime) & restart service
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
            set -euo pipefail
            cd /opt/telegram-bot/bot

            PY_REQ="requirements.txt"
            NODE_PKG="package.json"

            if [ -f "$PY_REQ" ] && [ -f "$NODE_PKG" ]; then
              echo "Both $PY_REQ and $NODE_PKG exist. Ambiguous runtime. Abort."
              exit 1
            elif [ -f "$PY_REQ" ]; then
              echo "Detected Python bot. Preparing venv and installing deps..."
              if [ ! -d "venv" ]; then
                python3 -m venv venv
              fi
              . venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
            elif [ -f "$NODE_PKG" ]; then
              echo "Detected Node.js bot. Installing deps..."
              if [ -f package-lock.json ]; then
                npm ci --omit=dev --no-audit --no-fund
              else
                npm i --omit=dev --no-audit --no-fund
              fi
            else
              echo "No requirements.txt or package.json found. Nothing to install."
            fi

            echo "Restarting service: telegram-bot"
            echo "${{ secrets.SERVER_PASSWORD }}" | sudo -S systemctl restart telegram-bot
            systemctl is-active --quiet telegram-bot && echo "Service is active"
            echo "--- Recent logs ---"
            journalctl -u telegram-bot -n 40 --no-pager || true
          '