#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è –∑–∞–π–Ω—è—Ç–∏—Ö –ø–æ—Ä—Ç—ñ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –±–æ—Ç–∞

echo "üßπ –û—á–∏—â–µ–Ω–Ω—è –∑–∞–π–Ω—è—Ç–∏—Ö –ø–æ—Ä—Ç—ñ–≤..."

# –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø—Ä–æ—Ü–µ—Å–∏, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –ø–æ—Ä—Ç 8081
PORT=8081
PID=$(lsof -ti:$PORT 2>/dev/null)

if [ -n "$PID" ]; then
    echo "‚ö†Ô∏è –ó–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å $PID –Ω–∞ –ø–æ—Ä—Ç—É $PORT"
    echo "üîÑ –ó–∞–≤–µ—Ä—à—É—é –ø—Ä–æ—Ü–µ—Å..."
    kill -TERM $PID 2>/dev/null
    
    # –ß–µ–∫–∞—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
    sleep 3
    
    # –Ø–∫—â–æ –ø—Ä–æ—Ü–µ—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è, –ø—Ä–∏–º—É—Å–æ–≤–æ –∑–∞–≤–µ—Ä—à—É—î–º–æ
    if kill -0 $PID 2>/dev/null; then
        echo "üîÑ –ü—Ä–∏–º—É—Å–æ–≤–æ –∑–∞–≤–µ—Ä—à—É—é –ø—Ä–æ—Ü–µ—Å..."
        kill -KILL $PID 2>/dev/null
        sleep 1
    fi
    
    echo "‚úÖ –ü–æ—Ä—Ç $PORT –∑–≤—ñ–ª—å–Ω–µ–Ω–æ"
else
    echo "‚úÖ –ü–æ—Ä—Ç $PORT –≤—ñ–ª—å–Ω–∏–π"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —ñ–Ω—à—ñ –ø—Ä–æ—Ü–µ—Å–∏ –±–æ—Ç–∞
BOT_PIDS=$(pgrep -f "bot.py\|health_check.py" 2>/dev/null)
if [ -n "$BOT_PIDS" ]; then
    echo "‚ö†Ô∏è –ó–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å–∏ –±–æ—Ç–∞: $BOT_PIDS"
    echo "üîÑ –ó–∞–≤–µ—Ä—à—É—é –ø—Ä–æ—Ü–µ—Å–∏..."
    kill -TERM $BOT_PIDS 2>/dev/null
    sleep 3
    
    # –ü—Ä–∏–º—É—Å–æ–≤–æ –∑–∞–≤–µ—Ä—à—É—î–º–æ, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
    for pid in $BOT_PIDS; do
        if kill -0 $pid 2>/dev/null; then
            echo "üîÑ –ü—Ä–∏–º—É—Å–æ–≤–æ –∑–∞–≤–µ—Ä—à—É—é –ø—Ä–æ—Ü–µ—Å $pid..."
            kill -KILL $pid 2>/dev/null
        fi
    done
    
    echo "‚úÖ –í—Å—ñ –ø—Ä–æ—Ü–µ—Å–∏ –±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
fi

echo "üßπ –û—á–∏—â–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
